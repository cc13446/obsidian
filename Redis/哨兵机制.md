转载自`https://pdai.tech`

## 哨兵机制（Redis Sentinel）
Redis哨兵，在Redis 2.8版本开始引入。哨兵的核心功能是主节点的自动故障转移。

下图是一个典型的哨兵集群监控的逻辑图：

![[Pasted image 20220506104110.png]]

哨兵实现了什么功能呢？下面是Redis官方文档的描述：
-   监控 `Monitoring`：哨兵会不断地检查主节点和从节点是否运作正常。
-   自动故障转移 `Automatic failover`：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。
-   配置提供者 `Configuration provider` ：客户端在初始化时，通过连接哨兵来获得当前Redis服务的主节点地址。
-   通知 `Notification`：哨兵可以将故障转移的结果发送给客户端。

其中，监控和自动故障转移功能，使得哨兵可以及时发现主节点故障并完成转移；而配置提供者和通知功能，则需要在与客户端的交互中才能体现。

### 哨兵集群的组建

哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是发布 / 订阅机制。

在主从集群中，主库上有一个名为`__sentinel__:hello`的频道，不同哨兵就是通过它来相互发现，实现互相通信的。在下图中，哨兵 1 把自己的 IP`172.16.19.3`和端口`26579`发布到`__sentinel__:hello`频道上，哨兵 2 和 3 订阅了该频道。那么此时，哨兵 2 和 3 就可以从这个频道直接获取哨兵 1 的 IP 地址和端口号。然后，哨兵 2、3 可以和哨兵 1 建立网络连接。

![[Pasted image 20220506104308.png]]

通过这个方式，哨兵 2 和 3 也可以建立网络连接，这样一来，哨兵集群就形成了。它们相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事儿进行判断和协商。

### 哨兵监控Redis库
哨兵监控由哨兵向主库发送 INFO 命令来完成。就像下图所示，哨兵 2 给主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵。接着，哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续地对从库进行监控。哨兵 1 和 3 可以通过相同的方法和从库建立连接。

![[Pasted image 20220506104458.png]]

### 主库下线的判定
哨兵如何判断主库已经下线了呢？

首先要理解两个概念：主观下线和客观下线
-   主观下线：任何一个哨兵都是可以监控探测，并作出Redis节点下线的判断；
-   客观下线：有哨兵集群共同决定Redis节点是否下线；

当某个哨兵（如下图中的哨兵2）判断主库主观下线后，就会给其他哨兵发送 `is-master-down-by-addr` 命令。接着，其他哨兵会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞成票，N 相当于反对票。

![[Pasted image 20220506104700.png]]

如果赞成票数（这里是2）大于等于哨兵配置文件中的 `quorum` 配置项, 则可以判定主库客观下线

### 哨兵集群的选举
#### 为什么必然会出现选举/共识机制
为了避免哨兵的单点情况发生，所以需要一个哨兵的分布式集群。作为分布式集群，必然涉及共识问题；同时故障的转移和通知都只需要一个主的哨兵节点就可以了。

#### 哨兵的选举机制是什么样的

哨兵的选举机制很简单，就是一个`Raft`选举算法： 选举的票数大于等于`num(sentinels)/2+1`时，将成为领导者，如果没有超过，继续选举

任何一个想成为 Leader 的哨兵，要满足两个条件：
-   第一，拿到半数以上的赞成票
-   第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值

以 3 个哨兵为例，假设此时的 `quorum` 设置为 2，那么，任何一个想成为 Leader 的哨兵只要拿到 2 张赞成票，就可以了。

一个例子:
> Redis 1主4从，5个哨兵，哨兵配置quorum为2，如果3个哨兵故障，当主库宕机时，哨兵能否判断主库客观下线？能否自动切换？

经过实际测试：

1. 哨兵集群可以判定主库主观下线。由于`quorum=2`，所以当一个哨兵判断主库主观下线后，询问另外一个哨兵后也会得到同样的结果，2个哨兵都判定主观下线，达到了 `quorum` 的值，因此，哨兵集群可以判定主库为客观下线。
2. 但哨兵不能完成主从切换。哨兵标记主库客观下线后，在选举哨兵领导者时，一个哨兵必须拿到超过多数的选票(5/2+1=3票)。但目前只有2个哨兵活着，无论怎么投票，一个哨兵最多只能拿到2票，永远无法达到`N/2+1`选票的结果。

### 新主库的选出
主库既然判定客观下线了，那么如何从剩余的从库中选择一个新的主库呢？
1. 过滤掉不健康的（下线或断线），没有回复过哨兵ping响应的从节点
2. 选择`salve-priority`从节点优先级最高（redis.conf）的
3. 选择复制偏移量最大，指复制最完整的从节点

![[Pasted image 20220506105352.png]]

###  故障的转移

新的主库选择出来后，就可以开始进行故障的转移了。

假设：判断主库客观下线了，同时选出`sentinel 3`是哨兵leader

![[Pasted image 20220506105549.png]]

故障转移流程如下
1. 将slave-1脱离原从节点（PS: 5.0 中应该是`replicaof no one`)，升级主节点，
2. 将从节点slave-2指向新的主节点
3. 通知客户端主节点已更换
4. 将原主节点（oldMaster）变成从节点，指向新的主节点