# RDB持久化
为了解决内存数据在进程退出后消失的问题，Redis提供了RDB持久化功能，这个功能可以将Redis在内存中的数据库状态保存到磁盘里面，避免数据意外丢失。

RDB持久化既可以手动执行，也可以根据服务器配置选项定期执行，该功能可以将某个时间点上的数据库状态保存到一个RDB文件中。

## RDB文件的创建与载入
有两个Redis命令可以用于生成RDB文件：
1. `SAVE`：会阻塞Redis服务器进程，直到RDB文件创建完毕为止
2. `BGSAVE`：派生出一个子进程负责创建RDB文件，服务器进程继续处理命令请求

```python
def SAVE():  
  
    # 创建RDB文件
    rdbSave()  
  
def BGSAVE():  
  
    # 创建子进程  
    pid = fork()  
    
    if pid == 0:  
  
        # 子进程负责创建RDB文件  
        rdbSave()  
  
        # 完成之后向父进程发送信号
        signal_parent()  
  
    elif pid > 0:  
  
        # 父进程继续处理命令请求，并通过轮询等待子进程的信号  
        handle_request_and_wait_signal()  
  
    else:  
    
        # 处理出错情况  
        handle_fork_error()
```

RDB文件的载入工作是在服务器启动时自动执行的，所以Redis并没有专门用于载入RDB文件的命令，只要Redis服务器在启动时检测到RDB文件存在，它就会自动载入RDB文件。

因为AOF文件的更新频率通常比RDB文件的更新频率高，所以如果服务器开启了AOF持久化功能，那么服务器会优先使用AOF文件来还原数据库状态。

### BGSAVE命令执行时的服务器状态
在`BGSAVE`命令的子进程创建RDB文件的过程中，Redis服务器仍然可以继续处理客户端的命令请求，但是，服务器处理`SAVE`、`BGSAVE`、`BGREWRITEAOF`三个命令的方式会和平时有所不同。
1. `SAVE`命令会被服务器拒绝，避免父进程和子进程同时执行`rdbSave`调用，产生竞争条件
2. `BGSAVE`命令会被服务器拒绝，同时执行两个`BGSAVE`命令也会产生竞争条件
3. `BGREWRITEAOF`和`BGSAVE`两个命令不能同时执行，避免两个大量磁盘写入的子进程：
	1. `BGSAVE`命令正执行，`BGREWRITEAOF`命令会被延迟到`BGSAVE`命令执行完毕之后
	2. `BGREWRITEAOF`命令正执行，`BGSAVE`命令会被服务器拒绝

### RDB文件载入时的服务器状态
服务器在载入RDB文件期间，会一直处于阻塞状态，直到载入工作完成为止。

