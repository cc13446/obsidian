# 跳跃表
跳跃表是一种有序数据结构，在每个节点中维持着多个指向其他节点的指针，可以快速访问节点。支持平均`O(logN)`、最坏`O(N)`复杂度的节点查找，还可以通过顺序性操作来批量处理节点。

在大部分情况下，跳跃表的效率可以和平衡树相媲美，并且因为跳跃表的实现比平衡树要来得更为简单，所以有不少程序都使用跳跃表来代替平衡树。

Redis使用跳跃表作为有序集合键的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中元素的成员是比较长的字符串时，Redis会使用跳跃表来作为有序集合键的底层实现。

Redis只在两个地方用到了跳跃表：
1. 实现有序集合键
2. 在集群节点中用作内部数据结构

## 跳跃表的实现
### 跳跃表节点
```c
typedef struct zskiplistNode {  
  
    // 层
    struct zskiplistLevel {  
  
        // 前进指针  
        struct zskiplistNode *forward;  
  
        // 跨度  
        unsigned int span;  
  
    } level[];  
  
    // 后退指针  
    struct zskiplistNode *backward;  
  
    // 分值
    double score;  
  
    // 成员对象
    robj *obj;  
  
} zskiplistNode;
```
#### 层
跳跃表节点的`level`数组可以包含多个元素，每个元素都包含一个指向其他节点的指针，程序可以通过这些层来加快访问其他节点的速度，一般来说，层的数量越多，访问其他节点的速度就越快。

每次创建一个新跳跃表节点的时候，程序都根据**幂次定律**随机生成一个介于1和32之间的值作为`level`数组的大小，这个大小就是层的高度。

具体的做法是：**跳表创建节点时候，会生成范围为`[0-1]`的一个随机数，这个随机数小于`0.25`，那么层数就增加 1 层，然后继续生成下一个随机数，直到随机数的结果大于`0.25`结束，最终确定该节点的层数，层高最大限制是 64。**

幂次定律：越大的数出现的概率越小。

#### 前进指针
每个层都有一个指向表尾方向的前进指针，用于从表头向表尾方向访问节点。

#### 跨度
层的跨度用于记录两个节点之间的距离：
1. 两个节点之间的跨度越大，它们相距得就越远。
2. 指向`NULL`的所有前进指针的跨度都为0，因为它们没有连向任何节点。

跨度实际上是用来计算排位的：在查找某个节点的过程中，将沿途访问过的所有层的跨度累计起来，得到的结果就是目标节点在跳跃表中的排位。

#### 后退指针
节点的后退指针用于从表尾向表头方向访问节点：跟可以一次跳过多个节点的前进指针不同，因为每个节点只有一个后退指针，所以每次只能后退至前一个节点。

#### 值和成员
节点的分值是一个`double`类型的浮点数，跳跃表中的所有节点都按分值从小到大来排序。

节点的成员对象是一个指针，它指向一个字符串对象，而字符串对象则保存着一个SDS值。

在同一个跳跃表中，各个节点保存的成员对象必须是唯一的，但是多个节点保存的分值却可以是相同的：分值相同的节点将按照成员对象在字典序中的大小来进行排序，成员对象较小的节点会排在前面，而成员对象较大的节点则会排在后面。

### 跳跃表
```c
typedef struct zskiplist {  
  
    // 表头节点和表尾节点  
    structz skiplistNode *header, *tail;  
  
    // 表中节点的数量  
    unsigned long length; 
  
    // 表中层数最大的节点的层数  
    int level;  
  
} zskiplist;
```

### 跳表的结构
![](5.跳跃表/Pasted%20image%2020220524100232.png)
### 跳表节点查询过程
查找一个跳表节点的过程中，跳表会从头节点的最高层开始，逐一遍历每一层。在遍历某一层的跳表节点时，会用跳表节点中的 SDS 类型的元素和元素的权重来进行判断，共有两个判断条件：
-   当前节点的权重**小于**要查找的权重时，跳表就会访问该层的下一个节点
-   当前节点的权重**等于**要查找的权重并且SDS类型数据**小于**要查找的数据时，访问该层的下一个节点

如果上面两个条件都不满足，或者下一个节点为空时，跳表就会使用目前遍历到的节点的 `level` 数组里的下一层指针，然后沿着下一层指针继续查找，这就相当于跳到了下一层接着查找。

## 跳跃表API
![](5.跳跃表/Pasted%20image%2020220524101137.png)

![](5.跳跃表/Pasted%20image%2020220524101143.png)
