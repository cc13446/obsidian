# 简单动态字符串
Redis构建了叫做简单类型字符串`simple dynamic string, SDS`的抽象类型，作为默认的字符串表示。C字符串只会作为字符串字面量用在一些无需对字符串值进行修改的地方，当Redis需要一个可以被修改的字符串值时，Redis就会使用SDS来表示字符串值。

除了用来保存数据库中的字符串值之外，SDS还被用作缓冲区：
1. AOF模块中的AOF缓冲区
2. 客户端状态中的输入缓冲区

## SDS的定义
```c
struct sdshdr {  
  
    // 记录buf数组中已使用字节的数量  
    // 等于SDS所保存字符串的长度  
    int len;  
  
    // 记录buf数组中未使用字节的数量  
    int free;  
  
    // 字节数组，用于保存字符串  
    char buf[];  
    
};
```
![](2.简单动态字符串/Pasted%20image%2020220522215706.png)
SDS遵循C字符串以空字符结尾的惯例，保存空字符的1字节空间不计算在SDS的`len`属性里面，并且为空字符分配额外的1字节空间，以及添加空字符到字符串末尾等操作，都是由SDS函数自动完成的，所以这个空字符对于SDS的使用者来说是完全透明的。空字符结尾的好处是，SDS可以直接重用一部分C字符串函数库里面的函数。

## SDS和C字符串的区别
C字符串不能满足Redis对字符串在安全性、效率以及功能方面的要求：
-   获取字符串长度的时间复杂度为 `O(N)`
-   字符串的结尾是以 `\0` 字符标识，字符串里面不能包含有 `\0` 字符，因此不能保存二进制数据
-   字符串操作函数不高效且不安全，比如有缓冲区溢出的风险，有可能会造成程序运行终止

### 常数复杂度获取字符串长度
SDS在`len`属性中记录了SDS本身的长度，可以用`O(1)`的复杂度获取字符串长度。设置和更新SDS长度的工作是由SDS的API在执行时自动完成的，使用SDS无须进行任何手动修改长度的工作。

### 杜绝缓冲区溢出
举个例子，`<string.h>`中`strcat`函数可以将`src`字符串中的内容拼接到`dest`字符串的末尾：
```c
char *strcat(char *dest, const char *src);  
```

因为C字符串不记录自身的长度，所以`strcat`假定用户在执行这个函数时，已经为`dest`分配了足够多的内存，可以容纳`src`字符串中的所有内容，而一旦这个假定不成立时，就会产生缓冲区溢出。

SDS的空间分配策略完全杜绝了发生缓冲区溢出的可能性：
1. 当SDS API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求
2. 不满足的时候API会自动将SDS的空间扩展至修改所需的大小，然后才执行实际的修改操作
3. 所以使用SDS既不需要手动修改SDS的空间大小，也不会出现前面所说的缓冲区溢出问题

### 减少修改字符串时带来的内存重分配次数
因为C字符串并不记录自身的长度，所以对于一个包含了`N`个字符的C字符串来说，这个C字符串的底层实现总是一个`N+1`个字符长的数组，留下额外的一个字符空间用于保存空字符。每次增长或者缩短一个C字符串，程序都总要对保存这个C字符串的数组进行一次内存重分配操作：
1. 防止缓冲区溢出：增长字符串先扩展底层数组
2. 防止内存泄露：缩短字符串先释放字符串不再使用的那部分空间

Redis对于速度要求很严格，内存重分配的时间可能对性能造成影响。所以SDS通过未使用空间解除了字符串长度和底层数组长度之间的关联，由`free`字段记录。

#### 空间预分配
对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必须要的空间，还会为SDS分配额外的未使用空间：
1. 内存空间修改后长度小于1MB，多分配和`len`属性同样大小的未使用空间
2. 内存空间修改后长度大于等于1MB， 多分配1MB的未使用空间

#### 惰性空间释放
惰性空间释放用于优化SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用`free`属性将这些字节的数量记录起来等待将来使用。

当然也存在真正释放SDS未使用空间的API。

### 二进制安全
SDS使用`len`属性的值而不是`\0`来判断字符串是否结束，所以使用SDS来保存二进制数据就不会出现数据中有`\0`导致的数据预先截断的问题。为了确保Redis可以适用于各种不同的使用场景，SDS的API也都是二进制安全的，所有SDS API都会以处理二进制的方式来处理SDS存放在`buf`数组里的数据，程序不会对其中的数据做任何限制和假设，数据在写入时是什么样的，被读取时就是什么样。

### 兼容部分C字符串函数
SDS的`buf`一样遵循C字符串以空字符结尾的惯例，Redis API总会将SDS保存的数据的末尾设置为空字符，并且总会在为`buf`数组分配空间时多分配一个字节来容纳这个空字符，这样保存文本数据的SDS就可以重用一部分`<string.h>`库定义的函数。

### 总结
![](2.简单动态字符串/Pasted%20image%2020220523103718.png)

## SDS API
![](2.简单动态字符串/Pasted%20image%2020220523103743.png)

![](2.简单动态字符串/Pasted%20image%2020220523103754.png)

