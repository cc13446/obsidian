# 文件
1. 参数文件：告诉Mysql启动时在哪里找到数据库文件，并且指定某些初始化参数
2. 日志文件：记录Mysql实例对某种条件做出响应时写入的文件
	1. 错误日志文件
	2. 二进制日志文件
	3. 慢查询日志文件
	4. 查询日志文件
	5. ...
3. socket文件：用UNIX套接字方式进行数据库连接时需要
4. PID文件：Mysql实例的进程ID文件
5. MySQL表结构文件：存放MySQL表结构定义的文件
6. 存储引擎文件：真正记录了记录和索引等数据

## 参数文件
MySQL会按照一定的顺序在指定位置进行读取，如果没有找到会按照编译MySQL的时候指定的默认值和源代码中指定的默认值运行。

### 什么是参数
可以简单的把参数看作一个键值对。可以通过`SHOW VARIABLES`查看数据库中的所有参数，可以通过`LIKE`来过滤参数名。从`MySQL 5.1`版本开始，还可以通过`information_schema`架构下的`GLOBAL_VARIABLES`视图来进行查找。

### 参数类型
参数可以分为两类：
1. 动态参数：可以在实例运行时进行修改，可以用`SET`进行修改
2. 静态参数：整个实例生命周期内都不可以进行更改

动态参数的修改可以使用`globle`和`session`关键字，他们表明该参数修改是基于当前会话还是整个实例的生命周期。有些动态参数只能在会话中进行修改，而有些参数修改完会在实例的整个生命周期都生效，有些既可以在会话中又可以在整个实例的生命周期内生效。

## 日志文件
### 错误日志
用户可以通过命令`SHOW VARIABLES LIKE'log_error'`来定位该文件。可以查看MySQL不能启动的原因和建议修改的警告。

### 慢查询日志
慢查询日志可以定位到存在问题的SQL语句。可以在MySQL启动的时候设置一个阈值，将运行时间超过该值的所有SQL语句都记录到慢查询日志中。该阈值可以通过参数`long_query_time`来设置，默认值为10，代表10秒。从`MySQL 5.1`开始，`long_query_time`开始以微秒记录SQL语句运行的时间，之前仅用秒为单位记录。

在默认情况下，MySQL数据库并不启动慢查询日志，需要将`log_slow_queries`设为ON。

另一个和慢查询日志有关的参数是`log_queries_not_using_indexes`，如果运行的SQL语句没有使用索引，则MySQL数据库同样会将这条SQL语句记录到慢查询日志文件。`MySQL 5.6.5`版本开始新增了一个参数`log_throttle_queries_not_using_indexes`，用来表示每分钟允许记录到慢查询日志的且未使用索引的SQL语句次数。默认为0表示没有限制，可以在生产环境下设置这个参数来减慢慢查询日志文件增大的速度。

参数`log_output`指定了慢查询输出的格式，默认为`FILE`，可以将它设为`TABLE`，然后就可以查询`mysql`架构下的`slow_log`表了，这样可以将慢查询日志放在一张表里。默认使用CSV引擎，可以切换`MyISAM`然后在`start_time`列上建立索引提高查询效率。

InnoSQL版本加强了对于SQL语句的捕获方式。在原版MySQL的基础上在慢查询日志中增加了对于逻辑读取和物理读取的统计。这里的物理读取是指从磁盘进行IO读取的次数，逻辑读取包含所有的读取，不管是磁盘还是缓冲池。可以通过额外的参数`long_query_io`将超过指定逻辑IO次数的SQL语句记录到慢查询日志中。该值默认为100，即记录逻辑读取次数大于100的SQL语句。而为了兼容原MySQL数据库的运行方式，还添加了参数`slow_query_type`，用来表示启用慢查询日志的方式，可选值为：
- 0表示不将SQL语句记录到慢查询日志
- 1表示根据运行时间将SQL语句记录到慢查询日志
- 2表示根据逻辑IO次数将SQL语句记录到慢查询日志
- 3表示根据运行时间及逻辑IO次数将SQL语句记录到慢查询日志

### 查询日志
记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行。从`MySQL 5.1`开始，可以将查询日志的记录放入`mysql`架构下的`general_log`表中

### 二进制日志
记录了对MySQL数据库执行更改的所有操作，但是不包括`SELECT`和`SHOW`这类操作，因为这类操作对数据本身并没有修改。

进制日志主要有以下几种作用。
1. 恢复：某些数据的恢复需要二进制日志。
	- 数据库全备文件恢复后，用户可以通过二进制日志进行`point-in-time`的恢复。
2. 复制：其原理与恢复类似，
	- 通过复制和执行二进制日志使一台远程的MySQL数据库与一台MySQL数据库进行实时同步
3. 审计：用户可以通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入的攻击。

通过配置参数`log-bin[=name]`可以启动二进制日志。如果不指定`name`，则默认二进制日志文件名为主机名，后缀名为二进制日志的序列号，所在路径为数据库所在目录`datadir`。

以下配置文件的参数影响着二进制日志记录的信息和行为：
- `max_binlog_size`：单个二进制日志文件的最大值
- `binlog_cache_size`：基于会话的未提交二进制日志缓存大小
	- 记录过多时存入一个临时文件
	- 事务提交时将缓存中的二进制日志写入二进制日志文件
- `sync_binlog`：二进制日志文件缓冲写入文件的行为
	- 二进制日志不是在每次写的时候同步磁盘，宕机时，可能有一部分数据没有写入二进制日志文件
	- 参数`sync_binlog=[N]`表示每写缓冲多少次就同步到磁盘
- `binlog-do-db`：需要写入那些库的日志
- `binlog-ignore-db`：忽略写入哪些库的日志
- `log-slave-update`：搭建主从架构的复制
- `binlog_format`：
	- `STATEMENT`格式：二进制日志文件记录的是日志的逻辑SQL语句
	- `ROW`格式：二进制日志记录的不再是简单的SQL语句了，而是记录表的行更改情况
	- `MIXED`格式：默认采用`STATEMENT`格式记录二进制日志文件，在一些情况下会使用`ROW`格式
		- 表的存储引擎为NDB，这时对表的DML操作都会以ROW格式记录
		- 使用了`UUID()`、`USER()`等不确定函数
		- 使用了`INSERT DELAY`语句
		- 使用了用户定义函数
		- 使用了临时表

要查看二进制日志文件的内容，必须通过MySQL提供的工具`mysqlbinlog`。对于`STATEMENT格式`的二进制日志文件，在使用`mysqlbinlog`后，看到的就是执行的逻辑SQL语句。但是如果这时使用ROW格式的记录方式，会发现`mysqlbinlog`的结果变得不可读。只要加上参数`-v`或`-vv`就能清楚地看到执行的具体信息了。

## 套接字文件
UNIX系统下本地连接MySQL可以采用UNIX域套接字方式，这种方式需要一个套接字文件。套接字文件可由参数socket控制。一般在`/tmp`目录下，名为`mysql.sock`。

## pid文件
当MySQL实例启动时，会将自己的进程ID写入一个文件中，该文件即为pid文件。该文件可由参数`pid_file`控制，默认位于数据库目录下，文件名为`主机名.pid`。

## 表结构定义文件
因为MySQL插件式存储引擎的体系结构的关系，MySQL数据的存储是根据表进行的，每个表都会有与之对应的文件。但不论表采用何种存储引擎，MySQL都有一个以`frm`为后缀名的文件，这个文件记录了该表的表结构定义。

`frm`还用来存放视图的定义，如用户创建了一个`v_a`视图，那么对应地会产生一个`v_a.frm`文件，用来记录视图的定义，该文件是文本文件，可以直接使用cat命令进行查看。

## InnoDB存储引擎文件

之前介绍的文件都是MySQL数据库本身的文件，和存储引擎无关。除了这些文件外，每个表存储引擎还有其自己独有的文件。本节将具体介绍与InnoDB存储引擎密切相关的文件
1. 重做日志文件
2. 表空间文件

### 表空间文件
InnoDB采用将存储的数据按表空间进行存放的设计。在默认配置下会有一个初始大小为10MB，名为`ibdata1`的文件。该文件就是默认的表空间文件，用户可以通过参数`innodb_data_file_path`对其进行设置，例如：
```properties
# 路径、大小、自动增长
innodb_data_file_path=/db/ibdata1:2000M;/dr2/db/ibdata2:2000M:autoextend
```
若设置了参数`innodb_file_per_table`，则用户可以将每个基于InnoDB存储引擎的表产生一个独立表空间。独立表空间的命名规则为`表名.ibd`。通过这样的方式，用户不用将所有数据都存放于默认的表空间中。这些单独的表空间文件仅存储该表的数据、索引和插入缓冲`BITMAP`等信息，其余信息还是存放在默认的表空间中。

### 重做日志文件
默认情况下，在InnoDB存储引擎的数据目录下会有两个名为`ib_logfile0`和`ib_logfile1`的文件。发生宕机的时候，重做日志文件就会发生作用，用来恢复保证数据的完整性。每个InnoDB存储引擎至少有1个重做日志文件组，每个文件组下至少有2个重做日志文件。为了得到更高的可靠性，用户可以设置多个的镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。

在日志组中每个重做日志文件的大小一致，并以循环写入的方式运行。InnoDB存储引擎先写重做日志文件1，当达到文件的最后时，会切换至重做日志文件2，再当重做日志文件2也被写满时，会再切换到重做日志文件1中。

下列参数影响着重做日志文件的属性：
- `innodb_log_file_size`：重做日志大小
- `innodb_log_files_in_group`：重做日志文件的数量
- `innodb_mirrored_log_groups`：日志镜像文件组的数量
- `innodb_log_group_home_dir`：日志文件组所在的路径

与二进制日志的区别：
1. 记录的范围不同
	1. 二进制日志会记录所有与MySQL数据库有关的日志记录
	2. InnoDB存储引擎的重做日志只记录有关该存储引擎本身的事务日志
2. 记录的内容不同
	1. 二进制日志文件记录的是关于一个事务的具体操作内容，即该日志是逻辑日志
	2. InnoDB存储引擎的重做日志文件记录的是关于每个页更改的物理情况
3. 写入的时间不同
	1. 二进制日志文件仅在事务提交前进行提交，即只写磁盘一次，不论这时该事务多大
	2. 在事务进行的过程中，却不断有重做日志条目被写入到重做日志文件中

在InnoDB存储引擎中，对于各种不同的操作有着不同的重做日志格式。到`1.2.x`版本为止，总共定义了51种重做日志类型。虽然各种重做日志的类型不同，但是它们有着基本的格式：
1. `redo_log_type` 占用1字节，表示重做日志的类型
2. `space` 表示表空间的ID，但采用压缩的方式，因此占用的空间可能小于4字节
3. `page_no` 表示页的偏移量，同样采用压缩的方式
4. `redo_log_body` 表示每个重做日志的数据部分，恢复时需要调用相应的函数进行解析

写入重做日志文件的操作不是直接写，而是先写入一个重做日志缓冲，然后按照一定的条件顺序的写入日志文件。往磁盘写入时按照512个字节，也就是一个扇区的大小进行写入。因为扇区是写入的最小单位所以一定是成功的，不需要`doublewrite`。
![](../Pasted%20image%2020220515142049.png)
从日志缓冲写入磁盘上的重做日志文件是按照一定的条件进行的：
1. 主线程每秒会将重做日志缓冲写入磁盘的重做日志文件，不论事务是否已经提交
2. 参数`innodb_flush_log_at_trx_commit`控制，表示在提交时，处理重做日志的方式
	- 0：不将事务的重做日志写入磁盘上的日志文件，而是等待主线程每秒的刷新
	- 1：将重做日志缓冲同步写到磁盘，即伴有`fsync`的调用
	- 2：将重做日志异步写到磁盘，即写到文件系统的缓存中
