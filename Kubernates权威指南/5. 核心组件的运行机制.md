## API Server
### 概述
通过进程`kube-apiserver`提供服务，运行在Master上，通过8080端口的HTTP或者6443端口HTTPS提供服务。kubectl与其之间的接口是RESTful API。

运行在Pod中的进程也可以调用K8S API，通常用来实现分布式集群搭建的目的。API Server本身也是一个Service，他的ClusterIP也是ClusterIP池中的第一个IP地址。

以下方法保证了API Server的性能：
1. 协程+队列的轻量级高性能并发代码
2. 普通List接口接合异步Watch接口
3. 高性能的etcd数据库

架构层级
1. API层：提供API接口
2. 访问控制层
3. 注册表层：把所有资源对象都保存在注册表中，并定义了对于资源对象的操作
4. etcd数据库：持久化的KV数据库

### 解读List-Watch机制
![](5.%20核心组件的运行机制/Pasted%20image%2020220731201306.png)
`etcd`提供了Watch API接口，API Server可以监听在etcd上面发生的数据操作事件，这些事件发生之后，etcd会及时通知API Server。为了让其他组件在不访问底层数据库的情况下也能及时获取资源对象的变化之间，API Server也模仿etcd实现了自己的Watch API。

K8S实现数据同步的代码逻辑为：
1. 客户端调用API Server的List接口，获取相关资源的全量数据并将其缓存到内存中
2. 启动对相应资源对象的Watch协程，收到Watch事件之后在进行同步修改

### CRD 在 API Server 中的设计和实现
每一种官方内建资源对象都包含以下主要功能：
1. 资源对象的元数据定义：定义了对应资源对象的数据结构，官方内建资源对象的元数据固化在源码
2. 资源对象的校验逻辑：确保用户提交的资源对象属性的合法性
3. 资源对象的CURD操作代码
4. 资源对象的自动控制器

每个CRD都需要实现上面的功能，直接编写YAML定义文件即可实现以上三个功能，最后一个功能由于有大量的API库和易用的List-Watch变成框架，所以自动控制器的编程难度大大降低。

### Proxy API 接口
代理REST请求，把收到的请求转发到某Node上的Kubelet守护进程的REST端口，Kubelet负责响应。

还可以将请求转发到Pod的相应端口，直接访问Pod的服务，当然也可以转发给Service。

## Controller Manage解析
Controller通过API Server的接口实时监控集群中特定资源的状态变化，并调整其状态为期望的状态。而Controller Manage就是这些Controller的管理者。

### Replication Controller 和 Deployment Controller
副本控制器和资源对象Replication Controller是不一样的，这里区分一下。