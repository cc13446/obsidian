# 概述
红黑树是一种结点带有颜色属性的二叉查找树，但它在二叉查找树之外，还有以下要求：
1.  节点是红色或黑色。
2.  根是黑色。
3.  所有叶子都是黑色（叶子是NIL节点）。
4.  每个红色节点必须有两个黑色的子节点。（不能有两个连续的红色节点。）
5.  从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。
	-  如果一个结点存在黑子结点，那么该结点肯定有两个子结点

# 2-3-4树
2-3-4树是四阶的B树(Balance Tree)，它的结构有以下限制：
-   所有叶子节点都拥有相同的深度。
-   节点只能是 2-节点、3-节点、4-节点之一。
    -   2-节点：包含 1 个元素的节点，有 2 个子节点；
    -   3-节点：包含 2 个元素的节点，有 3 个子节点；
    -   4-节点：包含 3 个元素的节点，有 4 个子节点；
-   元素始终保持排序顺序，整体上保持二叉查找树的性质
-   结点有多个元素时，每个元素必须大于它左边的和它的左子树中元素。

![[RedBlackTree_2-3-4Tree.png]]
## 对应红黑树
如果一棵树满足红黑树，把红结点收缩到其父结点，就变成了2-3-4树，所有红色节点都与其父节点构成3或4节点，其它节点为2节点。

![[RedBlackTree_2-3-4TreeToRBTree1.png]]

红黑树的每一类型操作都与2-3-4树一一对应。黑色节点的位置对应2-3-4树中的节点位置，这样可以很好的理解**从每个叶子到根的所有路径上不能有两个连续的红色节点**和**从任一节点到它所能到达得叶子节点的所有简单路径都包含相同数目的黑色节点**以及**根节点到任意叶子节点的路径长度，最多相差一半**。

而且一颗红黑树对应唯一形态的2-3-4树，但是一颗2-3-4树可以对应多种形态的红黑树，主要是3节点可以对应两种不同的红黑树形态。

![[RedBlackTree_2-3-4TreeToRBTree2.png]]

红黑树和 2-3-4树的结点添加和删除都有一个基本规则：避免子树高度变化，因为无论是 2-3-4树还是红黑树，一旦子树高度有变动，势必会影响其他子树进行调整，所以我们在插入和删除结点时尽量通过子树内部调整来达到平衡，2-3-4树实现平衡是通过结点的旋转和结点元素数变化，红黑树是通过结点旋转和变色。
# 节点插入
2-3-4树中结点添加需要遵守以下规则：
-   插入都是向最下面一层插入
-   升元：将插入结点由 2-结点升级成 3-结点，或由 3-结点升级成 4-结点
-   向 4-结点插入元素后，需要将中间元素提到父结点升元，原结点变成两个 2-结点，如果父结点也是 4-结点，则递归向上层升元，至到根结点后将树高加1

而将这些规则对应到红黑树里，就是：
-   新插入的结点颜色为`红色`，这样才可能不会对红黑树的高度产生影响
-   2-结点对应红黑树中的单个黑色结点，插入时直接成功(对应 2-结点升元)
-   3-结点对应红黑树中的`黑+红`子树，插入后将其修复成 `红+黑+红` 子树(对应 3-结点升元)
-   4-结点对应红黑树中的`红+黑+红`子树，插入后将其修复成`红色祖父+黑色父叔+红色孩子`子树，然后再把祖父结点当成新插入的红色结点递归向上层修复，直至修复成功或遇到 root 结点

# 节点删除

红黑树的删除要比插入要复杂一些，还是类比 2-3-4树来讲：
-   查找最近的叶子结点替代被删除元素，删除替代元素后，从替代元素所处叶子结点开始处理
-   降元：4-结点变 3-结点，3-结点变 2-结点
-   2-结点中只有一个元素，所以借兄弟结点中的元素来补充删除后的造成的空结点
-   当兄弟结点中也没有多个元素可以补充时，尝试将父结点降元，失败时向上递归，至到子树降元成功或到 root 结点树高减1

将这些规则对应到红黑树中即：
-   查找离当前结点最近的叶子结点作为替代结点，左子树的最右结点或右子树的最左结点都能保证替换后保证二叉查找树的结点的排序性质，叶子结点的替代结点是自身，用替代节点替换掉被删除结点，从替代的叶子结点向上递归修复
-   替代结点颜色为红色(对应 2-3-4树中 4-结点或 3-结点)时删除子结点直接成功；
-   替代结点为黑色(对应 2-3-4树中 2-结点)时，意味着替代结点所在的子树会降一层，需要依次检验以下三项，以恢复子树高度：
    -   兄弟结点的子结点中有红色结点(兄弟结点对应 3-结点或 4-结点)能够借用，旋转过来后修正颜色
    -   父结点是红色结点(父结点对应 3-结点或 4-结点，可以降元)时，将父结点变黑色，自身和兄弟结点变红色后删除
    -   父结点和兄弟结点都是黑色时，将子树降一层后把父结点当作替代结点递归向上处理

